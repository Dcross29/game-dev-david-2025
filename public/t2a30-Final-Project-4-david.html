<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>I will pop that bubble - lvl 4</title>

<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: url("BubbleGuard.gif") center / cover no-repeat fixed;
  height: 100vh;
  overflow: hidden;
}

h1 {
  text-align: center;
  color: red;
  margin-top: 10px;
}

/* FADE */
#fadeOverlay {
  position: fixed;
  inset: 0;
  background: black;
  z-index: 20000;
}

/* DIALOGUE */
#dialogueBox {
  position: fixed;
  bottom: 50px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.85);
  color: white;
  padding: 20px;
  border-radius: 15px;
  max-width: 550px;
  text-align: center;
  display: none;
  z-index: 10000;
}

#dialogueChoices button {
  display: block;
  margin: 10px auto;
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
}

/* SCREENS */
#successScreen, #deathScreen {
  position: fixed;
  inset: 0;
  background: black;
  display: none;
  z-index: 30000;
}

#successScreen img, #deathScreen img {
  width: 100vw;
  height: 100vh;
  object-fit: cover;
}

#proceedBtn {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  padding: 15px 30px;
  font-size: 20px;
  display: none;
  z-index: 40000;
  cursor: pointer;
}

/* GAME OVER */
#gameOver {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: red;
  z-index: 60000;
}

#gameOver button {
  margin-top: 20px;
  padding: 15px 30px;
  font-size: 20px;
  cursor: pointer;
}
</style>
</head>

<body>

<h1>I will pop that bubble - lvl 4</h1>

<div id="fadeOverlay"></div>

<div id="dialogueBox">
  <div id="dialogueText"></div>
  <div id="dialogueChoices"></div>
</div>

<!-- SCREENS -->
<div id="successScreen"><img src="guardleave.gif"></div>
<div id="deathScreen"><img src="death.gif"></div>

<button id="proceedBtn" onclick="location.href='level5.html'">Proceed</button>

<div id="gameOver">
  <h1>GAME OVER</h1>
  <button onclick="location.reload()">Restart</button>
</div>

<!-- AUDIO PLACEHOLDERS -->
<audio id="audioDialogue"></audio>
<audio id="audioSuccess"></audio>
<audio id="audioDeath"></audio>

<script>
/* ===== CONSTANTS ===== */
const TYPE_SPEED = 100;
const GUARD_GIF_DURATION = 1857;
const DEATH_DURATION = 2500;

/* ===== FADE ===== */
window.onload = () => {
  const f = document.getElementById("fadeOverlay");
  f.style.transition = "opacity 1s";
  f.style.opacity = 0;
  setTimeout(() => f.remove(), 1000);
};

/* ===== AUDIO ===== */
const dialogueAudio = document.getElementById("audioDialogue");
const successAudio  = document.getElementById("audioSuccess");
const deathAudio    = document.getElementById("audioDeath");

/* ===== DIALOGUE TREE ===== */
const dialogueTree = {
  text: "What brings you here. If it's the door, turn. Now.",
  audio: "",

  choices: [
    {
      label: "*say nothing*",
      next: {
        text: "..... Hello?",
        audio: "",
        choices: [
          {
            label: "*say nothing*",
            next: {
              text: "Fine. Be that way.",
              audio: "",
              death: true
            }
          },
          {
            label: "let me in",
            next: {
              text: "And why should I?",
              audio: "",
              choices: [
                {
                  label: "flaunt",
                  next: {
                    playerText: "Because I'm rich. If you go to that corner over there, I left some money.",
                    npcText: "Really!?",
                    audio: "",
                    success: true
                  }
                },
                {
                  label: "reason",
                  next: {
                    playerText: "You don't get paid enough for this.",
                    npcText: "I don't care.",
                    audio: "",
                    death: true
                  }
                }
              ]
            }
          }
        ]
      }
    },

    {
      label: "*offer a proposition*",
      next: {
        text: "State your offer.",
        audio: "",
        choices: [
          {
            label: "rock paper scissors",
            next: {
              npcText: "You think I'm here to play games?",
              audio: "",
              death: true
            }
          },
          {
            label: "give him whatever is in your pockets",
            next: {
              playerText: "Uhhh… I got some pocket lint and an old bubblegun wrapper.",
              npcText: "You wasted my time.",
              audio: "",
              death: true
            }
          },
          {
            label: "intimidation",
            next: {
              playerText: "You let me in, and I won't molly whop you right now.",
              npcText: "Big words for a corpse.",
              audio: "",
              death: true
            }
          }
        ]
      }
    },

    {
      label: "*insult*",
      next: {
        text: "Say it.",
        audio: "",
        choices: [
          {
            label: "insult his spear",
            next: {
              playerText: "Your spear is small.",
              npcText: "No it's not! It's average… besides. It's how you use it.",
              audio: "",
              success: true
            }
          },
          {
            label: "make fun of his legs",
            next: {
              playerText: "Your legs are so thin, skip leg day?",
              npcText: "Like you'd know anything about muscle, twig-bones.",
              audio: "",
              death: true
            }
          }
        ]
      }
    }
  ]
};

/* ===== ENGINE ===== */
const box = document.getElementById("dialogueBox");
const textEl = document.getElementById("dialogueText");
const choicesEl = document.getElementById("dialogueChoices");

function typeWriter(text, audioSrc, callback){
  textEl.textContent = "";
  let i = 0;

  if(audioSrc){
    dialogueAudio.src = audioSrc;
    dialogueAudio.play().catch(()=>{});
  }

  const interval = setInterval(() => {
    textEl.textContent += text[i++];
    if(i >= text.length){
      clearInterval(interval);
      callback && callback();
    }
  }, TYPE_SPEED);
}

function showNode(node){
  box.style.display = "block";
  choicesEl.innerHTML = "";

  typeWriter(node.text, node.audio, () => {
    if(node.choices){
      node.choices.forEach(c => {
        const btn = document.createElement("button");
        btn.textContent = c.label;
        btn.onclick = () => resolveChoice(c.next);
        choicesEl.appendChild(btn);
      });
    }
  });
}

function resolveChoice(n){
  choicesEl.innerHTML = "";

  if(n.playerText){
    typeWriter(n.playerText, n.audio, () => {
      typeWriter(n.npcText, n.audio, () => endNode(n));
    });
  } else if(n.npcText){
    typeWriter(n.npcText, n.audio, () => endNode(n));
  } else {
    showNode(n);
  }
}

function endNode(n){
  if(n.success){
    box.style.display = "none";
    successAudio.play().catch(()=>{});
    document.getElementById("successScreen").style.display = "block";
    setTimeout(() => {
      document.getElementById("proceedBtn").style.display = "block";
    }, GUARD_GIF_DURATION);
    return;
  }

  if(n.death){
    box.style.display = "none";
    deathAudio.play().catch(()=>{});
    document.getElementById("deathScreen").style.display = "block";
    setTimeout(() => {
      document.getElementById("deathScreen").style.display = "none";
      document.getElementById("gameOver").style.display = "flex";
    }, DEATH_DURATION);
    return;
  }

  showNode(n);
}

/* ===== START ===== */
showNode(dialogueTree);
</script>

</body>
</html>
