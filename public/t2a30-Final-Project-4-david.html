<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>I will pop that bubble - lvl 4</title>

<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: url("BubbleGuard.gif") center / cover no-repeat fixed;
  height: 100vh;
  overflow: hidden;
}

h1 { text-align: center; color: red; }

#fadeOverlay, #successScreen, #deathScreen {
  position: fixed;
  inset: 0;
  background: black;
  z-index: 20000;
}

#successScreen, #deathScreen { display:none; }

#successScreen img, #deathScreen img {
  width:100vw;
  height:100vh;
  object-fit:cover;
}

#dialogueBox {
  position: fixed;
  bottom: 50px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.85);
  color: white;
  padding: 20px;
  border-radius: 15px;
  max-width: 550px;
  text-align: center;
  display: none;
  z-index: 10000;
}

#dialogueChoices button {
  display:block;
  margin:10px auto;
  padding:10px 20px;
  font-size:16px;
  cursor:pointer;
}

#proceedBtn {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  padding: 15px 30px;
  font-size: 20px;
  display: none;
  z-index: 40000;
}

#gameOver {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: red;
  z-index: 60000;
}
</style>
</head>

<body>

<h1>I will pop that bubble - lvl 4</h1>

<div id="fadeOverlay"></div>

<div id="dialogueBox">
  <div id="dialogueText"></div>
  <div id="dialogueChoices"></div>
</div>

<div id="successScreen"><img src="guardleave.gif"></div>
<div id="deathScreen"><img src="death.gif"></div>

<button id="proceedBtn" onclick="location.href='t2a30-final-project-5-david.html'">Proceed</button>

<div id="gameOver">
  <h1>GAME OVER</h1>
  <button onclick="location.reload()">Restart</button>
</div>

<!-- MAIN AUDIO -->
<audio id="audioSuccess" src=""></audio>
<audio id="audioDeath" src=""></audio>

<!-- GUARD VOICE LINES (PUT FILENAMES HERE) -->
<audio id="g1" src="whatbringsyouhere.mov"></audio>
<audio id="g2" src="hello.mov"></audio>
<audio id="g3" src="alrightimdonewaiting.mov"></audio>
<audio id="g4" src="whyshouldi.mov"></audio>
<audio id="g5" src=""></audio>
<audio id="g6" src="seriously.mov"></audio>
<audio id="g7" src="tryit.mov"></audio>
<audio id="g8" src=""></audio>
<audio id="g9" src="itsaverage.mov"></audio>
<audio id="g10" src="muscle.mov"></audio>
<audio id="g11" src="really.mov"></audio>
<audio id="g12" src="dont care.mov"></audio>

<script>
/* ===== CONSTANTS ===== */
const TYPE_SPEED = 50;
const OUTCOME_DELAY = 700;
const GUARD_GIF_TIME = 1857;
const DEATH_TIME = 2500;

/* ===== FADE ===== */
window.onload = () => {
  const f = document.getElementById("fadeOverlay");
  f.style.transition = "opacity 1s";
  f.style.opacity = 0;
  setTimeout(()=>f.remove(),1000);
};

/* ===== DIALOGUE TREE ===== */
const dialogueTree = {
  text: "What brings you here. If it's the door, turn. Now.",
  choices: [
    {
      label: "*say nothing*",
      next: {
        text: "..... Hello?",
        choices: [
          {
            label: "*say nothing*",
            next: {
              npcText: "Alright. I'm done waiting.",
              death: true
            }
          },
          {
            label: "let me in",
            next: {
              text: "And why should I?",
              choices: [
                {
                  label: "flaunt",
                  next: {
                    playerText: "Because I'm rich. If you go to that corner over there, I left some money.",
                    npcText: "Really!?",
                    success: true
                  }
                },
                {
                  label: "reason",
                  next: {
                    playerText: "You don't get paid enough for this.",
                    npcText: "I don't care.",
                    death: true
                  }
                }
              ]
            }
          }
        ]
      }
    },
    {
      label: "*offer a proposition*",
      next: {
        text: "State your offer.",
        choices: [
          { label: "rock paper scissors", next: { rps: true } },
          {
            label: "give him whatever is in your pockets",
            next: {
              playerText: "Uhhh… I got some pocket lint and an old bubblegun wrapper.",
              npcText: "…Seriously?",
              death: true
            }
          },
          {
            label: "intimidation",
            next: {
              playerText: "You let me in, and I won't molly whop you right now.",
              npcText: "Try it.",
              death: true
            }
          }
        ]
      }
    },
    {
      label: "*insult*",
      next: {
        text: "Say it.",
        choices: [
          {
            label: "insult his spear",
            next: {
              playerText: "Your spear is small.",
              npcText: "No it's not! It's average… besides. It's how you use it.",
              success: true
            }
          },
          {
            label: "make fun of his legs",
            next: {
              playerText: "Your legs are so thin, skip leg day?",
              npcText: "Like you'd know anything about muscle, twig-bones.",
              death: true
            }
          }
        ]
      }
    }
  ]
};

/* ===== ENGINE ===== */
const box = document.getElementById("dialogueBox");
const textEl = document.getElementById("dialogueText");
const choicesEl = document.getElementById("dialogueChoices");

function type(text, cb){
  textEl.textContent="";
  let i=0;

  playGuardAudio(text);

  const t=setInterval(()=>{
    textEl.textContent+=text[i++];
    if(i>=text.length){
      clearInterval(t);
      stopAllGuardAudio();
      cb&&cb();
    }
  },TYPE_SPEED);
}

function show(node){
  box.style.display="block";
  choicesEl.innerHTML="";
  type(node.text, ()=>{
    node.choices?.forEach(c=>{
      const b=document.createElement("button");
      b.textContent=c.label;
      b.onclick=()=>resolve(c.next);
      choicesEl.appendChild(b);
    });
  });
}

function resolve(n){
  choicesEl.innerHTML="";

  if(n.rps){ startRPS(); return; }

  if(n.playerText){
    type(n.playerText,()=>type(n.npcText,()=>endWithDelay(n)));
    return;
  }

  if(n.npcText){
    type(n.npcText,()=>endWithDelay(n));
    return;
  }

  show(n);
}

function endWithDelay(n){
  setTimeout(()=>{
    if(n.success) success();
    if(n.death) death();
  }, OUTCOME_DELAY);
}

/* ===== RPS ===== */
function startRPS(){
  type("Rock. Paper. Scissors.", ()=>{
    ["Rock","Paper","Scissors"].forEach(p=>{
      const b=document.createElement("button");
      b.textContent=p;
      b.onclick=()=>playRPS(p);
      choicesEl.appendChild(b);
    });
  });
}

function playRPS(player){
  const npc=["Rock","Paper","Scissors"][Math.floor(Math.random()*3)];
  const win =
    (player==="Rock"&&npc==="Scissors")||
    (player==="Paper"&&npc==="Rock")||
    (player==="Scissors"&&npc==="Paper");

  type(`You chose ${player}. He chose ${npc}.`,()=>{
    type(win?"Hmph. You win.":"Nope. I win.",()=>{
      setTimeout(()=>win?success():death(), OUTCOME_DELAY);
    });
  });
}

/* ===== AUDIO MAP ===== */
function playGuardAudio(text){
  const map = {
    "What brings you here. If it's the door, turn. Now.":"g1",
    "..... Hello?":"g2",
    "Alright. I'm done waiting.":"g3",
    "And why should I?":"g4",
    "State your offer.":"g5",
    "…Seriously?":"g6",
    "Try it.":"g7",
    "Say it.":"g8",
    "No it's not! It's average… besides. It's how you use it.":"g9",
    "Like you'd know anything about muscle, twig-bones.":"g10",
    "Really!?":"g11",
    "I don't care.":"g12"
  };

  const id = map[text];
  if(!id) return;

  stopAllGuardAudio();
  const a = document.getElementById(id);
  a.currentTime = 0;
  a.play();
}

function stopAllGuardAudio(){
  for(let i=1;i<=12;i++){
    const a=document.getElementById("g"+i);
    a.pause();
  }
}

/* ===== OUTCOMES ===== */
function success(){
  document.getElementById("audioSuccess").play();
  box.style.display="none";
  document.getElementById("successScreen").style.display="block";
  setTimeout(()=>document.getElementById("proceedBtn").style.display="block",GUARD_GIF_TIME);
}

function death(){
  document.getElementById("audioDeath").play();
  box.style.display="none";
  document.getElementById("deathScreen").style.display="block";
  setTimeout(()=>{
    document.getElementById("deathScreen").style.display="none";
    document.getElementById("gameOver").style.display="flex";
  },DEATH_TIME);
}

/* ===== START ===== */
show(dialogueTree);
</script>

</body>
</html>
