<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>I will pop that bubble - lvl 5</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#222;
  font-family:sans-serif;
  opacity:0;
  transition:opacity 1s ease-in;
}

#gameArea{width:100vw;height:100vh;position:relative;}
#player{position:absolute;top:500px;left:50%;transform:translateX(-50%);z-index:3;}
#goober{width:120px;position:absolute;left:50%;top:350px;transform:translate(-50%,-50%);z-index:2;}

.door{
  width:80px;
  height:120px;
  position:absolute;
  top:100px;
  z-index:4;
  background:#5a3b28;
  border:5px solid #3a2416;
}
#doorLeft{left:30%;}
#doorRight{right:30%;}

#dialogueBox{
  position:fixed;
  bottom:40px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.85);
  color:white;
  padding:20px;
  border-radius:15px;
  max-width:500px;
  text-align:center;
  display:none;
  z-index:1000;
}

#choices button{
  display:block;
  margin:10px auto;
  padding:10px 20px;
  font-size:16px;
  cursor:pointer;
}

/* === OVERLAY === */
#overlay{
  position:fixed;
  inset:0;
  background:black;
  display:flex;
  opacity:0;
  pointer-events:none;
  transition:opacity 1s ease-in;
  z-index:2000;
}

#overlay.show{
  opacity:1;
  pointer-events:auto;
}

/* Image layer */
#overlayImage{
  position:absolute;
  inset:0;
  z-index:1000;
}

#overlayImage img{
  width:100vw;
  height:100vh;
  object-fit:cover;
}

/* Text layer */
#overlayContent{
  position:relative;
  z-index:2000;
  color:white;
  font-size:32px;
  text-align:center;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}

#overlayContent button{
  margin-top:30px;
  padding:15px 30px;
  font-size:22px;
  cursor:pointer;
}
</style>
</head>

<body>

<h1 style="color:red; text-align:center; margin:10px 0; position:fixed; top:0; left:50%; transform:translateX(-50%); z-index:100000;">
I will pop that bubble - lvl 5
</h1>

<div id="gameArea">
  <img id="player" src="mc.PNG">
  <img id="goober" src="goober.gif">
  <div id="doorLeft" class="door"></div>
  <div id="doorRight" class="door"></div>
</div>

<div id="dialogueBox">
  <div id="dialogueText"></div>
  <div id="choices"></div>
</div>

<div id="overlay">
  <div id="overlayImage"></div>
  <div id="overlayContent"></div>
</div>

<script>
const player = document.getElementById("player");
const goober = document.getElementById("goober");
const dialogueBox = document.getElementById("dialogueBox");
const textEl = document.getElementById("dialogueText");
const choicesEl = document.getElementById("choices");
const overlay = document.getElementById("overlay");
const overlayImage = document.getElementById("overlayImage");
const overlayContent = document.getElementById("overlayContent");

let keys = {};
let gooberSpoken = false;
let dialogueFinished = false;
let locked = false;
let typeComplete = false;

/* Fade-in page */
window.addEventListener("load", () => {
  document.body.style.opacity = "1";
});

/* Dialogue */
const dialogue = {
  text:"Hi! I'm the funny little goober that tells lies.",
  choices:[
    {label:"Which door has the bubble?",next:{text:"The bubble is behind the right door."}},
    {label:"What's with your one hair?",next:{
      text:"Oh that? That's actually an exposed nerve ending.",
      choices:[
        {label:"Pull it",next:{anti:true}},
        {label:"Don't pull it",next:{text:"The bubble is behind the right door, just fyi."}}
      ]
    }}
  ]
};

/* Typewriter */
function type(text,cb){
  textEl.textContent="";
  typeComplete=false;
  let i=0;
  const t=setInterval(()=>{
    textEl.textContent+=text[i++];
    if(i>=text.length){
      clearInterval(t);
      typeComplete=true;
      if(cb) cb();
    }
  },70);
}

/* Show dialogue */
function show(node){
  locked=true;
  dialogueBox.style.display="block";
  choicesEl.innerHTML="";
  type(node.text,()=>{
    if(node.choices){
      node.choices.forEach(c=>{
        const b=document.createElement("button");
        b.textContent=c.label;
        b.onclick=()=>handle(c.next);
        choicesEl.appendChild(b);
      });
    }else{
      dialogueFinished=true;
      locked=false;
      dialogueBox.style.display="none";
    }
  });
}

/* Show ending (FADE-IN) */
function showEnding(img,text,buttonHTML){
  locked=true;
  overlayImage.innerHTML=`<img src="${img}">`;
  overlayContent.innerHTML=`<div>${text}</div>${buttonHTML}`;
  overlay.classList.add("show");
}

/* Handle choice */
function handle(node){
  if(node.anti){
    dialogueBox.style.display="none";
    showEnding(
      "pull.gif",
      "ANTI-GOOBER ENDING",
      `<button onclick="location.reload()">Restart</button>`
    );
    return;
  }
  show(node);
}

function startDialogue(){
  if(gooberSpoken) return;
  gooberSpoken=true;
  show(dialogue);
}

/* Input */
document.addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

/* Game loop */
function movePlayer(){
  if(!locked){
    const speed=4;
    let top=player.offsetTop;
    let left=player.offsetLeft;

    if(keys.w && top>0) player.style.top=(top-speed)+"px";
    if(keys.s && top+player.offsetHeight<innerHeight) player.style.top=(top+speed)+"px";
    if(keys.a && left>0) player.style.left=(left-speed)+"px";
    if(keys.d && left+player.offsetWidth<innerWidth) player.style.left=(left+speed)+"px";
  }

  if(!gooberSpoken){
    const p=player.getBoundingClientRect();
    const g=goober.getBoundingClientRect();
    if(p.right>g.left && p.left<g.right && p.bottom>g.top && p.top<g.bottom){
      startDialogue();
    }
  }

  if(dialogueFinished && typeComplete && !locked){
    const p=player.getBoundingClientRect();
    const L=document.getElementById("doorLeft").getBoundingClientRect();
    const R=document.getElementById("doorRight").getBoundingClientRect();

    if(p.right>L.left && p.left<L.right && p.bottom>L.top && p.top<L.bottom){
      showEnding(
        "bad.gif",
        "DUNGEON OF ANTI-SILLY",
        `<button onclick="location.reload()">Restart</button>`
      );
    }

    if(p.right>R.left && p.left<R.right && p.bottom>R.top && p.top<R.bottom){
      showEnding(
        "success.gif",
        "NEXT LEVEL",
        `<button onclick="location.href='t2a30-final-project-6-david.html'">Proceed</button>`
      );
    }
  }

  requestAnimationFrame(movePlayer);
}

requestAnimationFrame(movePlayer);
</script>

</body>
</html>
