<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Final Level Fixed</title>
<style>
body{
  margin:0;
  overflow:hidden;
  background:black;
  font-family:arial;
}
#camera{
  position:absolute;
  width:100%;
  height:100vh;
  overflow:hidden;
}
#world{
  position:absolute;
  width:100%;
  height:300vh;
}
#floor1{
  height:100vh;
  background:#7a4a1c;
  position:relative;
}
#floor2{
  height:200vh;
  background:#111;
  position:relative;
}
#bed{
  position:absolute;
  left:60px;
  bottom:40px;
  width:180px;
  height:50px;
  background:#5a2d0c;
  border-radius:10px;
}
#bed:before{
  content:"";
  position:absolute;
  width:180px;
  height:25px;
  top:-25px;
  background:#c68642;
  border-radius:10px 10px 0 0;
}
#stairs{
  position:absolute;
  right:80px;
  bottom:0;
  width:160px;
  height:120px;
}
#stairs div{
  height:18px;
  background:#3b1f0b;
  margin-top:4px;
}
#player{
  position:absolute;
  z-index:10;
}
#bubble{
  position:absolute;
  width:90px;
  display:none;
  z-index:9;
}
#door{
  position:absolute;
  bottom:60px;
  left:50%;
  transform:translateX(-50%);
  width:140px;
  height:220px;
  background:#000;
  border:4px solid white;
  text-align:center;
  color:white;
  font-size:22px;
  line-height:220px;
}
#dialogue{
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  padding:15px 25px;
  color:white;
  border-radius:12px;
  display:none;
  z-index:100;
}
#run{
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  color:red;
  font-size:26px;
  display:none;
  z-index:200;
}
</style>
</head>
<body>

<div id="camera">
  <div id="world">
    <div id="floor1">
      <div id="bed"></div>
      <div id="stairs">
        <div></div><div></div><div></div><div></div><div></div>
      </div>
    </div>
    <div id="floor2">
      <div id="door">EXIT</div>
    </div>
  </div>
</div>

<img id="player" src="mc.PNG">
<img id="bubble" src="bubbleboss.gif">

<div id="run">RUN â†“</div>
<div id="dialogue"></div>

<script>
const player = document.getElementById("player");
const bubble = document.getElementById("bubble");
const stairs = document.getElementById("stairs");
const world = document.getElementById("world");
const door = document.getElementById("door");
const dialogue = document.getElementById("dialogue");
const run = document.getElementById("run");

let keys = {};
document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

/* STATE */
let onFloor2 = false;
let locked = false;
let chasing = false;

/* FIRST FLOOR PLAYER POS */
let px = 120;
let py = 70;

/* SECOND FLOOR WORLD COORDS */
let camY = 0;
let pX = 0, pY = 0;
let bX = 0, bY = 0;

/* INIT PLAYER ON BED */
player.style.left = px + "px";
player.style.bottom = py + "px";

/* MAIN LOOP */
setInterval(() => {
  if (!locked) move();
  if (!onFloor2) stairCheck();
  if (onFloor2 && chasing) {
    bubbleFollow();
    cameraFollow();
    doorCheck();
  }
  render();
},16);

/* MOVE PLAYER */
function move(){
  if (onFloor2){
    if(keys.a)pX-=4;
    if(keys.d)pX+=4;
    if(keys.w)pY+=4;
    if(keys.s)pY-=4;
    pX = Math.max(0,Math.min(window.innerWidth-player.width,pX));
    pY = Math.max(camY,pY);
  }else{
    if(keys.a)px-=4;
    if(keys.d)px+=4;
    if(keys.w)py+=4;
    if(keys.s)py-=4;
    px = Math.max(0,Math.min(window.innerWidth-player.width, px));
    py = Math.max(0,py);
  }
}

/* RENDER */
function render(){
  if(onFloor2){
    world.style.top = -camY + "px";
    player.style.left = pX + "px";
    player.style.bottom = (pY - camY) + "px";
    bubble.style.left = bX + "px";
    bubble.style.bottom = (bY - camY) + "px";
  }else{
    player.style.left = px + "px";
    player.style.bottom = py + "px";
  }
}

/* STAIRS COLLISION */
function stairCheck(){
  const stairsRect = {
    left: stairs.offsetLeft,
    right: stairs.offsetLeft + stairs.offsetWidth,
    top: stairs.offsetTop,
    bottom: stairs.offsetTop + stairs.offsetHeight
  };
  const playerRect = {
    left: px,
    right: px + player.width,
    top: py,
    bottom: py + 50
  };
  if(hit(playerRect, stairsRect)){
    show(`<button onclick="goDown()">Go downstairs</button>`);
  } else hide();
}

/* GO DOWN */
function goDown(){
  hide();
  onFloor2 = true;
  locked = true;

  camY = window.innerHeight;
  pX = window.innerWidth/2;
  pY = camY + 80;

  bX = window.innerWidth/2;
  bY = camY + window.innerHeight - 120;
  bubble.style.display = "block";

  setTimeout(bubbleDialogue, 500);
}

/* DIALOGUE */
function bubbleDialogue(){
  show(`"Join me or die."<br><br><button onclick="refuse()">Refuse</button>`);
}

/* REFUSE */
function refuse(){
  hide();
  locked = false;
  chasing = true;
  run.style.display = "block";
}

/* BUBBLE FOLLOW */
function bubbleFollow(){
  const dx = pX - bX;
  const dy = pY - bY;
  const d = Math.sqrt(dx*dx+dy*dy)||1;
  bX += dx/d*2.5;
  bY += dy/d*2.5;
}

/* CAMERA FOLLOW */
function cameraFollow(){
  camY = pY - 200;
  const doorScreen = door.offsetTop - camY;
  if(doorScreen < window.innerHeight - 260){
    camY = door.offsetTop - (window.innerHeight - 260);
  }
}

/* DOOR */
function doorCheck(){
  const doorRect = door.getBoundingClientRect();
  const playerRect = player.getBoundingClientRect();
  if(hit(playerRect,doorRect)){
    location.href="level2.html";
  }
}

/* UTILS */
function hit(a,b){
  return !(a.right<b.left||a.left>b.right||a.bottom<b.top||a.top>b.bottom);
}
function show(t){dialogue.innerHTML=t; dialogue.style.display="block";}
function hide(){dialogue.style.display="none";}
</script>
</body>
</html>
