<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Final Level</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:black;
  font-family:sans-serif;
  color:white;
  opacity:0;
  transition:opacity 1s ease-in;
}

/* Player */
#player{
  position:absolute;
  width:80px;
  height:auto;
  left:50%;
  bottom:40px;
  transform:translateX(-50%);
  z-index:10;
}

/* Bubble */
#bubble{
  position:absolute;
  width:100px;
  height:auto;
  top:0;
  left:50%;
  transform:translateX(-50%);
  z-index:9;
  display:none;
}

/* Dialogue */
#dialogue{
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.85);
  padding:20px;
  border-radius:12px;
  max-width:600px;
  text-align:center;
  z-index:100;
}

/* Fade */
#fade{
  position:fixed;
  inset:0;
  background:black;
  opacity:0;
  pointer-events:none;
  transition:opacity 1.5s ease;
  z-index:1000;
}
#fade.show{opacity:1}

/* Generator room */
#generatorRoom{
  position:fixed;
  inset:0;
  display:none;
}

.door{
  position:absolute;
  top:100px;
  width:120px;
  height:200px;
  border:4px solid #555;
  background:#111;
  text-align:center;
  line-height:200px;
  font-size:22px;
}
#doorA{left:15%;}
#doorS{left:50%;transform:translateX(-50%);}
#doorD{right:15%;}
.door.active{
  background:#400;
  border-color:red;
}

#generator{
  position:absolute;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  width:300px;
  height:40px;
  border:3px solid white;
}
#genFill{
  height:100%;
  width:0%;
  background:#00ff88;
}

/* Ending */
#ending{
  position:fixed;
  inset:0;
  background:black;
  display:none;
  z-index:2000;
  text-align:center;
  font-size:36px;
  display:flex;
  justify-content:center;
  align-items:center;
  flex-direction:column;
}
#ending button{
  margin-top:30px;
  padding:15px 30px;
  font-size:22px;
}
</style>
</head>

<body>

<img id="player" src="mc.PNG">
<img id="bubble" src="bubbleboss.gif">

<div id="dialogue"></div>
<div id="generatorRoom">
  <div id="doorA" class="door">A</div>
  <div id="doorS" class="door">S</div>
  <div id="doorD" class="door">D</div>

  <div id="generator"><div id="genFill"></div></div>

  <div style="position:fixed;top:20px;left:50%;transform:translateX(-50%);text-align:center;">
    HOLD <b>W</b> TO CHARGE<br>
    CLOSE DOORS WITH <b>A / S / D</b>
  </div>
</div>

<div id="fade"></div>
<div id="ending"></div>

<script>
const player = document.getElementById("player");
const bubble = document.getElementById("bubble");
const dialogue = document.getElementById("dialogue");
const fade = document.getElementById("fade");
const ending = document.getElementById("ending");
const genFill = document.getElementById("genFill");
const generatorRoom = document.getElementById("generatorRoom");

const doors = {
  a: document.getElementById("doorA"),
  s: document.getElementById("doorS"),
  d: document.getElementById("doorD")
};

let keys = {};
let alive = true;
let genProgress = 0;
let activeDoor = null;

/* Fade in */
window.onload = ()=>document.body.style.opacity="1";

/* Input */
document.addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

/* Dialogue helpers */
function showDialogue(html){
  dialogue.innerHTML = html;
}
function clearDialogue(){
  dialogue.innerHTML = "";
}

/* Wake up */
setTimeout(()=>{
  showDialogue(`
    You wake up.<br><br>
    <button onclick="bubbleReveal()">Go downstairs</button>
  `);
},1500);

/* Bubble choice */
function bubbleReveal(){
  showDialogue(`
    Join me… or I shoot you.<br><br>
    <button onclick="join()">Join him</button>
    <button onclick="refuse()">Refuse</button>
  `);
}

/* Join path */
function join(){
  showDialogue(`
    He lowers his guard.<br><br>
    <button onclick="badEnding()">...</button>
    <button onclick="snakeEnding()">Strike him while he's vulnerable</button>
  `);
}

function badEnding(){
  endScreen("BAD ENDING<br>YOU JOINED THE BUBBLE");
}

function snakeEnding(){
  endScreen("SNAKE ENDING<br>YOU POPPED HIM");
}

/* Refuse → chase */
function refuse(){
  clearDialogue();
  bubble.style.display="block";
  let y = 0;

  const chase = setInterval(()=>{
    y += 4;
    bubble.style.top = y+"px";
    if(y > innerHeight-150){
      clearInterval(chase);
      startFinalSequence();
    }
  },16);
}

/* Final sequence */
function startFinalSequence(){
  bubble.style.display="none";
  fade.classList.add("show");

  setTimeout(()=>{
    fade.classList.remove("show");
    generatorRoom.style.display="block";
    runGenerator();
    bubbleAttacks();
  },1500);
}

function runGenerator(){
  function loop(){
    if(keys.w && alive){
      genProgress += 0.15;
      genFill.style.width = genProgress+"%";
      if(genProgress >= 100){
        endScreen("CHEATER OF CONSEQUENCE");
        return;
      }
    }
    requestAnimationFrame(loop);
  }
  loop();
}

function bubbleAttacks(){
  setInterval(()=>{
    if(activeDoor || !alive) return;
    if(Math.random() < 0.6) return;

    const list=["a","s","d"];
    activeDoor = list[Math.floor(Math.random()*3)];
    doors[activeDoor].classList.add("active");

    const killTimer = setTimeout(()=>die(),1500);

    function handler(e){
      if(e.key.toLowerCase() === activeDoor){
        clearTimeout(killTimer);
        doors[activeDoor].classList.remove("active");
        activeDoor = null;
        document.removeEventListener("keydown",handler);
      }
    }
    document.addEventListener("keydown",handler);
  },5000);
}

function die(){
  alive=false;
  fade.classList.add("show");
  setTimeout(()=>location.reload(),1500);
}

/* Ending */
function endScreen(text){
  alive=false;
  fade.classList.add("show");
  setTimeout(()=>{
    ending.style.display="flex";
    ending.innerHTML = `
      <div>${text}</div>
      <button onclick="location.reload()">Restart</button>
    `;
  },1500);
}
</script>

</body>
</html>
