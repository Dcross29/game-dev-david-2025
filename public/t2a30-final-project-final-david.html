<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Final Level - Part 1</title>
<style>
body{
  margin:0;
  overflow:hidden;
  font-family:sans-serif;
  background:brown;
}

/* Room container */
#wakeRoom{
  width:100vw;
  height:100vh;
  position:relative;
}

/* First floor (bed room) */
#firstFloor{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:#8B4513; /* brown room */
  z-index:1;
}

/* Bed */
#bed{
  position:absolute;
  width:150px;
  height:auto;
  left:80px;
  bottom:40px;
  z-index:2;
}

/* Stairs */
#stairs{
  position:absolute;
  bottom:0;
  left:60%;
  transform:translateX(-50%);
  width:200px;
  height:150px;
  z-index:2;
}
#stairs div{
  background:#654321;
  height:20px;
  margin-top:5px;
}

/* Lower floor */
#lowerFloor{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:#444; /* dark gray */
  display:none;
  z-index:0;
}

/* Player */
#player{
  position:absolute;
  z-index:10;
}

/* Dialogue box */
#dialogue{
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.85);
  padding:20px;
  border-radius:12px;
  max-width:600px;
  text-align:center;
  color:white;
  display:none;
  z-index:100;
}
#dialogue button{
  margin-top:10px;
  padding:10px 20px;
  font-size:16px;
}

/* Bubble */
#bubble{
  position:absolute;
  width:80px;
  height:auto;
  top:0;
  left:50%;
  transform:translateX(-50%);
  display:none;
  z-index:9;
}

/* Final door */
#finalDoor{
  position:absolute;
  width:120px;
  height:200px;
  right:50px;
  bottom:50px;
  background:#222;
  border:4px solid white;
  text-align:center;
  line-height:200px;
  font-size:22px;
  display:none;
  cursor:pointer;
}
</style>
</head>
<body>

<div id="wakeRoom">
  <!-- First floor -->
  <div id="firstFloor">
    <img id="bed" src="bed.png">
    <div id="stairs">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
    </div>
  </div>

  <!-- Lower floor -->
  <div id="lowerFloor"></div>

  <!-- Player -->
  <img id="player" src="mc.PNG">

  <!-- Bubble -->
  <img id="bubble" src="bubbleboss.gif">

  <!-- Final door -->
  <div id="finalDoor">Door</div>
</div>

<div id="dialogue"></div>

<script>
const player = document.getElementById("player");
const firstFloor = document.getElementById("firstFloor");
const lowerFloor = document.getElementById("lowerFloor");
const stairs = document.getElementById("stairs");
const dialogue = document.getElementById("dialogue");
const bubble = document.getElementById("bubble");
const finalDoor = document.getElementById("finalDoor");

let keys = {};
let alive = true;
let onFirstFloor = true;
let atStairs = false;

/* Track player position */
let playerX = 120; // start near bed
let playerY = 60;  
player.style.left = playerX + "px";
player.style.bottom = playerY + "px";

/* Input */
document.addEventListener("keydown", e=>keys[e.key.toLowerCase()]=true);
document.addEventListener("keyup", e=>keys[e.key.toLowerCase()]=false);

/* Movement loop */
function movePlayer(){
  if(keys.a) playerX -= 4;
  if(keys.d) playerX += 4;
  if(keys.w) playerY += 4;
  if(keys.s) playerY -= 4;

  // constrain to window
  const rect = player.getBoundingClientRect();
  if(playerX < 0) playerX = 0;
  if(playerX > window.innerWidth - rect.width) playerX = window.innerWidth - rect.width;
  if(playerY < 0) playerY = 0;
  if(playerY > window.innerHeight - rect.height) playerY = window.innerHeight - rect.height;

  player.style.left = playerX + "px";
  player.style.bottom = playerY + "px";

  // check stairs on first floor
  if(onFirstFloor && checkStairs()){
    if(!atStairs){
      atStairs = true;
      showDialogue(`<button onclick="goDownstairs()">Go downstairs</button>`);
    }
  } else {
    atStairs = false;
    if(onFirstFloor) hideDialogue();
  }
}
setInterval(movePlayer,16);

function checkStairs(){
  const stairRect = stairs.getBoundingClientRect();
  const playerRect = player.getBoundingClientRect();
  return !(playerRect.right < stairRect.left || playerRect.left > stairRect.right || 
           playerRect.bottom < stairRect.top || playerRect.top > stairRect.bottom);
}

function showDialogue(html){
  dialogue.innerHTML = html;
  dialogue.style.display="block";
}
function hideDialogue(){
  dialogue.style.display="none";
}

/* Go downstairs function */
function goDownstairs(){
  hideDialogue();
  onFirstFloor = false;
  firstFloor.style.display = "none";
  lowerFloor.style.display = "block";

  // move player to bottom of lower floor
  playerX = window.innerWidth/2 - player.width/2;
  playerY = 40;
  player.style.left = playerX + "px";
  player.style.bottom = playerY + "px";

  // start bubble walk up after short delay
  setTimeout(()=>bubbleWalkUp(), 500);
}

/* Bubble walk up */
function bubbleWalkUp(){
  bubble.style.display="block";
  bubble.style.top = window.innerHeight + "px";
  let bubbleY = window.innerHeight;
  const interval = setInterval(()=>{
    bubbleY -= 3;
    bubble.style.top = bubbleY + "px";
    if(bubbleY <= player.getBoundingClientRect().top){
      clearInterval(interval);
      bubbleConfront();
    }
  },16);
}

/* Bubble confrontation */
function bubbleConfront(){
  showDialogue(`
    The Bubble appears.<br>
    "Join meâ€¦ or I shoot you."<br><br>
    <button onclick="joinBubble()">Join him</button>
    <button onclick="refuseBubble()">Refuse</button>
  `);
}

function joinBubble(){
  hideDialogue();
  alert("Join path would go here (BAD or SNAKE endings).");
}

function refuseBubble(){
  hideDialogue();
  startChase();
}

/* Chase sequence */
function startChase(){
  bubble.style.display="block";
  bubble.style.top="0px";
  let bubbleY = 0;
  let chasePlayerX = playerX;
  const chaseInterval = setInterval(()=>{
    if(!alive) { clearInterval(chaseInterval); return; }
    bubbleY += 3;
    bubble.style.top = bubbleY+"px";

    // WASD horizontal movement
    if(keys.a) chasePlayerX -= 4;
    if(keys.d) chasePlayerX += 4;
    if(chasePlayerX<0) chasePlayerX=0;
    if(chasePlayerX>window.innerWidth-50) chasePlayerX = window.innerWidth-50;
    player.style.left = chasePlayerX+"px";
    playerX = chasePlayerX;

    // bubble reaches bottom
    if(bubbleY >= window.innerHeight-150){
      clearInterval(chaseInterval);
      bubble.style.display="none";
      finalDoor.style.display="block";
    }
  },16);
}

/* Final door click */
finalDoor.addEventListener("click", ()=>{
  location.href="finalSequence.html";
});
</script>

</body>
</html>
